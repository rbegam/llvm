; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt -S -jump-threading -distant-jump-threading -jump-thread-loop-header < %s | FileCheck %s

; Previously we crashed due to following the %tmp5 phi to reach the %tmp2 phi.
; This would cause bb4 to be a subregion top and subregion bottom which we
; can't currently handle.

define void @foo() {
; CHECK-LABEL: @foo(
; CHECK-NEXT:  bb:
; CHECK-NEXT:    br label [[BB1:%.*]]
; CHECK:       bb1:
; CHECK-NEXT:    [[TMP:%.*]] = phi i32 [ 45, [[BB:%.*]] ], [ 0, [[BB10:%.*]] ]
; CHECK-NEXT:    [[TMP2:%.*]] = phi i32 [ 0, [[BB]] ], [ [[TMP2]], [[BB10]] ]
; CHECK-NEXT:    [[TMP3:%.*]] = shl i32 [[TMP]], 1
; CHECK-NEXT:    br label [[BB4:%.*]]
; CHECK:       bb4:
; CHECK-NEXT:    [[TMP5:%.*]] = phi i32 [ [[TMP3]], [[BB1]] ], [ [[TMP2]], [[BB4]] ]
; CHECK-NEXT:    [[TMP6:%.*]] = icmp ugt i32 undef, [[TMP]]
; CHECK-NEXT:    br i1 [[TMP6]], label [[BB7:%.*]], label [[BB4]]
; CHECK:       bb7:
; CHECK-NEXT:    switch i32 [[TMP5]], label [[BB9:%.*]] [
; CHECK-NEXT:    i32 66, label [[BB10]]
; CHECK-NEXT:    i32 0, label [[BB8:%.*]]
; CHECK-NEXT:    ]
; CHECK:       bb8:
; CHECK-NEXT:    unreachable
; CHECK:       bb9:
; CHECK-NEXT:    unreachable
; CHECK:       bb10:
; CHECK-NEXT:    br label [[BB1]]
;
bb:
  br label %bb1

bb1:                                              ; preds = %bb10, %bb
  %tmp = phi i32 [ 45, %bb ], [ 0, %bb10 ]
  %tmp2 = phi i32 [ 0, %bb ], [ %tmp2, %bb10 ]
  %tmp3 = shl i32 %tmp, 1
  br label %bb4

bb4:                                              ; preds = %bb4, %bb1
  %tmp5 = phi i32 [ %tmp3, %bb1 ], [ %tmp2, %bb4 ]
  %tmp6 = icmp ugt i32 undef, %tmp
  br i1 %tmp6, label %bb7, label %bb4

bb7:                                              ; preds = %bb4
  switch i32 %tmp5, label %bb9 [
  i32 66, label %bb10
  i32 0, label %bb8
  ]

bb8:                                              ; preds = %bb7
  unreachable

bb9:                                              ; preds = %bb7
  unreachable

bb10:                                             ; preds = %bb7
  br label %bb1
}
